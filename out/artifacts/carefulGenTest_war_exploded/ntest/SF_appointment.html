<!DOCTYPE html>
<html>
<head>
<title>预约顺丰快递</title>

<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
<script src="../js/jquery.js"></script>

<!-- 引入样式和js文件 -->
<link rel="stylesheet" type="text/css" href="css/mobileSelect.css" />
<script src="js/mobileSelect.js" type="text/javascript"></script>
<script src="../dist/clipboard.min.js"></script>
<script src="../layui/layui.js" charset="utf-8"></script>
<link rel="stylesheet" href="../layui/css/layui.css" />
<style type="text/css">
.top_word {
	margin-top: 12%;
	margin-left: 5%;
	width: 90%;
	line-height: 20px;
	font-size: 14px;
	font-family: PingFangSC-Regular, PingFang SC;
	font-weight: 400;
	color: #333333;
}

.middle_info {
	width: 90%;
	min-height: 300px;
	background: #FFFFFF;
	border-radius: 6px;
	margin: auto;
}

.down_info {
	width: 90%;
	min-height: 104px;
	background: #FFFFFF;
	border-radius: 6px;
	margin: auto;
}

.middle_title {
	font-size: 16px;
	font-weight: 500;
	color: #333333;
	line-height: 22px;
	padding-top: 20px;
	padding-left: 20px;
}

.middle_input {
	width: 65%;
	height: 22px;
	background-color: #FFFFFF;
	border: unset;
	padding-left: 36px;
	padding-bottom: 16px;
	outline: none;
	font-weight: 400;
	font-size: 16px;
	-webkit-appearance: none;
	border-radius: 0;
}

.middle_input::placeholder {
	width: 73%;
	height: 22px;
	font-size: 16px;
	font-family: PingFangSC-Regular, PingFang SC;
	font-weight: 400;
	color: #999999;
	line-height: 22px;
}

.line {
	width: 90%;
	margin: auto;
	border-bottom: solid 1px #e8e8e8;
}

.down_button {
	text-align: center;
	margin-top: 10%;
}

.appointment_button {
	width: 90%;
	height: 44px;
	background-color: #75CEC8;
	border-radius: 6px;
	color: #FFFFFF;
	font-size: 17px;
	font-family: PingFangSC-Medium, PingFang SC;
	font-weight: 500;
	line-height: 24px;
	border: unset;
}

.popupStyle {
	display: none;
	width: 50%;
	background-color: rgb(85, 85, 85);
	color: #fff;
	text-align: center;
	border-radius: 6px;
	padding: 8px 8px;
	position: fixed;
	text-align: center;
	z-index: 1;
	top: 50%;
	left: 25%;
}

.popupStyle::after {
	position: absolute;
	top: 50%;
	left: 50%;
	margin-left: -5px;
	border-width: 5px;
	border-style: solid;
	border-color: #555 transparent transparent transparent;
}

.own_back {
	border: unset;
	color: #75CEC8;
	background-color: #F5F5F5;
	padding-left: 0px;
}
		
.confirm_ul {
	list-style: none;
	margin: 0px;
	padding: 0px;
	width: 70%;
	margin: auto;
	margin-top: 60%;
}

.confirm_title {
	background: #F2F2F2;
	text-align: left;
	padding-left: 20px;
	line-height: 60px;
	border: 1px solid #999;
}

.confirm_content {
	background: #fff;
	text-align: center;
	font-size: 16px;
	margin: 0;
	padding: 10px;
	line-height: 50px;
	border: none;
	border-radius: 10px 10px 0px 0px;
}

.confirm_btn-wrap {
	display: flex;
	background: #fff;
	height: 40px;
	line-height: 30px;
	text-align: right;
	border: none;
	border-radius: 0px 0px 10px 10px;
}

.confirm_btn {
	color: #75CEC8;
	font-size: 18px;
	width: 50%;
	text-align: center;
}

.confirm_btn-wrap>a:nth-child(1) {
	color: #9c9898;
	font-size: 18px;
	width: 50%;
	text-align: center;
}
</style>
</head>
<body style="background-color:#F5F5F5;">
	<div class="top_word">
		如果你想自行回寄，选择到付即可。
		<button onclick="showInfo()" class="own_back">自行回寄须知</button>
	</div>
	<br>
	<div class="middle_info">
		<div
			style="font-size: 16px;font-weight: 500;color: #75CEC8;line-height: 22px;padding-top: 20px; padding-left: 20px;">
			<span>寄件人信息</span>
			<span style=" font-size: 14px; color: #333333;">(上门取件地址)</span>
		</div>
		<div class="middle_title">
			<span>寄件人</span> <input type="text" class="middle_input" id="name"
				placeholder="请填写寄件人姓名" maxlength="20" />
			<div class="line"></div>
		</div>
		<div class="middle_title">
			<span>手机号</span> <input type="tel" class="middle_input" id="phone"
				placeholder="请填写寄件人手机号码" maxlength="13" />
			<ul id="phone_name" class="tl-input" size="10"
				style="display:none;position: absolute;
    						max-height: 200px; overflow: auto; list-style: inside; width: 55%; background-color: rgb(255, 255, 255); border: 1px solid rgb(113, 113, 113);
    						border-radius: 5px; text-align: center; padding: 0px; margin-left: 20%;"></ul>
			<div class="line"></div>
		</div>
		<div class="middle_title">
			<span>所在地区</span> <input type="text" class="middle_input" id="area"
				placeholder="请选择所在地区" style="padding-left: 20px;width:60%;"
				readonly="readonly" /> <img src="images/right.png"
				style="width: 7px;height: 12px;">
			<div class="line"></div>
		</div>
		<div class="middle_title">
			<span>详细地址</span> <input type="text" class="middle_input"
				id="address" placeholder="请填写详细地址" style="padding-left: 20px;"
				maxlength="50" />
		</div>
	</div>
	<br>
	<div class="down_info">
		<div
			style="font-size: 16px;font-weight: 500;color: #75CEC8;line-height: 22px;padding-top: 20px; padding-left: 20px;">
			<span>期望取件时间</span>
		</div>
		<div class="middle_title">
			<span>上门时间</span> <input type="text" class="middle_input" id="time"
				placeholder="请选择上门时间" style="padding-left: 20px;width:60%;"
				readonly="readonly" /> <img src="images/right.png"
				style="width: 7px;height: 12px;">

		</div>
	</div>
	<div class="down_button">
		<button class="appointment_button" onclick="appointmentExpress()">立即预约顺丰快递</button>
	</div>
</body>
<script type="text/javascript">
	function GetRequest() {
		var url = location.search; //获取url中"?"符后的字串
		var theRequest = new Object();
		if (url.indexOf("?") != -1) {
			var str = url.substr(1);
			strs = str.split("&");
			for (var i = 0; i < strs.length; i++) {
				theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
			}
		}
		return theRequest;

	}
	var Request = new Object();
	Request = GetRequest();
	var valOpenid = Request['openid'];
	var sample_id = Request['sample_id'];
	var phone = "";

	var province_list = [];
	var city_list = [];
	var district_list = [];
	var UplinkData = [];
	$(function() {
		var url = location.search; //获取url中"?"符后的字串
		getPhone();
		getArea();
		getTime();
	});

	//后台获取地区
	function getArea() {
		$.getJSON("area_info.json", function(result) {
			console.log(result.area_info);
			UplinkData.concat(result.area_info);
			var mobileSelect5 = new MobileSelect({
				trigger : "#area",
				title : "选择地区",
				wheels : [ {
					data : result.area_info
				} ],
				position : [ 0, 0 ],
				transitionEnd : function(indexArr, data) {
					//console.log(data);
				},
				callback : function(indexArr, data) {
					console.log(data);
					var area = data[0].value + " " + data[1].value + " " + data[2].value;
					$('#area').val(area);
				},
			});
		});
	}

	//后台获取手机号
	function getPhone() {
		$.ajax({
			url : "../apihealth/getPhone.hn",
			dataType : "json",
			data : {
				"openid" : valOpenid
			},
			success : function(data) {
				if (data.success) {
					phone = data.result;
					
					//点击“预约顺丰快递回寄” 判断是否存在 “已预约快递但未取件状态”的快递,若存在,则弹窗提示;若不存在则直接进⼊预约快递
					$.ajax({
						url : "../express/IsPostTogether.hn",
						type : 'post',
						data : {
							send_phone : phone,
						},
						dataType : "json",
						success : function(data) {
							if (data.success) {
								Confirm('您已通过其他检测项目预约过快递，若快递员还没有上门取件，您可以选择一起邮寄。', function () {
									$.ajax({
										url : "../express/UpdateSameBatch.hn",
										type : 'post',
										data : {
											send_number : data.send_number,
											sample_id : sample_id
										},
										dataType : "json",
										success : function(data) {
											if (data.success) {
												handleDomMsg(data.msg);
												window.location = "./appointment_success.html?sample_id=" + sample_id + "&openid=" + valOpenid;
											} else {
												console.log("未查询到可一起邮寄的快递")
											}
										}
									});
								})
							} else {
								console.log("未查询到可一起邮寄的快递")
							}
						}
					});
				}
			}
		});
	}
	$("#phone").on({
		click : function(event) {
			var a = $("#phone").val();
			var select = $("#phone_name");
			select.html("");
			if (phone != undefined && phone != "") {
				select.append('<li onclick="changeD(this)" style="line-height:30px">' + phone + '</li>');
				$("#phone_name").css({
					"display" : ""
				});
			}
		},
		blur : function(event) {
			setTimeout(
				'$("#phone_name").css({ "display": "none" })', 10
			)

		},
		input : function(event) {
			setTimeout(
				'$("#phone_name").css({ "display": "none" })', 10
			)
		},
	});
	function changeD(this_) {
		var a = $(this_).text();
		$("#phone").val(changephone(a));
		$("#phone_name").css({
			"display" : "none"
		});
	}

	//344格式
	function changephone(phone) {
		var value = phone.replace(/\D/g, '').substring(0, 11);
		var valueLen = value.length;
		if (valueLen > 3 && valueLen < 8) {
			value = value.replace(/^(...)/g, "$1 ");
		} else if (valueLen >= 8) {
			value = value.replace(/^(...)(....)/g, "$1 $2 ");
		}
		return value;

	}
	$('#phone').change(function() {
		console.log($('#phone').val());
		var Phone = $('#phone').val();
		var value = changephone(Phone);
		console.log(value);
		$(this).val(value);
	});


	$('#phone').keyup(function() {
		var value = $(this).val().replace(/\D/g, '').substring(0, 11);
		var valueLen = value.length;
		if (valueLen > 3 && valueLen < 8) {
			value = value.replace(/^(...)/g, "$1 ");
		} else if (valueLen >= 8) {
			value = value.replace(/^(...)(....)/g, "$1 $2 ");
		}
		$(this).val(value);

	});

	//弱提示方法
	// DOM 弹窗
	function handleDomMsg(message) {
		const div = document.createElement("div");
		document.body.appendChild(div);
		div.innerHTML = message || "this is a Message";
		div.className = "popupStyle";
		div.style.display = "block";
		div.style.zIndex = "20000000";
		setTimeout(() => {
			div.remove();
		}, 2000);
	}

	//选择预约的时间  
	/* var weekdayArr = [ "今天", "明天", "后天" ];
	var timeArr = [
		"08:00-09:00",
		"09:00-10:00",
		"10:00-11:00",
		"11:00-12:00",
		"12:00-13:00",
		"13:00-14:00",
		"14:00-15:00",
		"15:00-16:00",
		"16:00-17:00",
		"17:00-18:00"
	];
	//时间选择器
      var mobileSelect2 = new MobileSelect({
        trigger: "#time",
        title: "预约时间选择",
        wheels: [{ data: weekdayArr }, { data: timeArr }],
        position: [0, 0],
        transitionEnd: function (indexArr, data) {
          console.log(data);
        },
        callback: function (indexArr, data) {
          console.log(data);
          var time = data[0]+" "+data[1]
          
          //预约选择判断时间是否大于当前时间
          console.log(time);
          var day = time.split(" ")[0];
          var time_SF = time.split(" ")[1];
          console.log(time_SF);
          var h = time_SF.split("-")[1];
          var hour = h.split(":")[0];
          var today = new Date();//返回当前日期和时间
          var hh = today.getHours();//返回 Date 对象的小时 (0 ~ 23)
          if (day=="今天") {
            if(hour<=hh){
                var msg = "预约时间不能小于当前时间";
                handleDomMsg(msg);
                $('#sampling_end_time').val("");
            }else{
                $('#time').val(time); 
            }    
          }else{
              $('#time').val(time); 
          }
        },
      }); */

	layui.use([ 'layer' ], function() {
		var layer = layui.layer;
	})
	function showInfo() {
		var content = "<div style='text-align: center;font-size: 16px;font-family: PingFangSC-Medium, PingFang SC;font-weight: 500;color: #333333;line-height: 22px;margin: 20px auto;'>自行回寄须知</div>"
			+ "<div style='padding: 0px 20px;height: 60%;font-size: 14px;font-family: PingFangSC-Regular, PingFang SC;font-weight: 400;color: #333333;line-height: 20px;'>1. 回寄收件人信息<br>"
			+ "收件人：卡尤迪大健康样本<br>"
			+ "电话：+86-13716457705<br>"
			+ "公司名称：卡尤迪医学检验实验室<br>"
			+ "详细地址： 北京市昌平区北大医疗产业园15号楼2层<br><br>"
			+ "2. 如果您的所在地不在顺丰的取件范围内，可以选择其他快递，邮费到付即可。<br><br>"
			+ "3. 如遇快递员拒收，请联系电话 +86-13716457705</div>";
		layer.open({
			type : 1,
			title : false, //不显示标题栏
			closeBtn : true,
			area : [ '70%', '60%' ],
			shade : 0.8,
			id : 'LAY_layuipro', //设定一个id，防止重复弹出
			resize : false,
			scrollbar : false,
			btn : [ '复制回寄收件地址' ],
			btnAlign : 'c',
			moveType : 1, //拖拽模式，0或者1
			content : content,
			yes : function() {
				const textCopied = ClipboardJS.copy("北京市昌平区北大医疗产业园15号楼2层");
				handleDomMsg("复制成功");
			//layer.closeAll();
			}
		});
	}

	function appointmentExpress() {
		var phone = $('#phone').val();

		if ($("#name").val().length == 0) {
			var msg = "请填写寄件人真实姓名";
			handleDomMsg(msg);
			return;
		}
		if (phone.length == 0) {
			var msg = "请填写寄件人手机号码";
			handleDomMsg(msg);
			return;
		}
		phone = phone.split(" ")[0] + phone.split(" ")[1] + phone.split(" ")[2];
		console.log(phone);
		if (!(/(^1[123456789]\d{9}$)/.test(phone))) {
			var msg = "手机号格式错误";
			handleDomMsg(msg);
			return;
		}
		if ($("#area").val().length == 0) {
			var msg = "请选择寄件人所在地区";
			handleDomMsg(msg);
			return;
		}
		if ($("#address").val().length == 0) {
			var msg = "请填写寄件人详细地址";
			handleDomMsg(msg);
			return;
		}
		if ($("#time").val().length == 0) {
			var msg = "请选择你期望上门的时间";
			handleDomMsg(msg);
			return;
		}
		var today = new Date(); //返回当前日期和时间
		var hh = today.getHours(); //返回 Date 对象的小时 (0 ~ 23)
		var time = $("#time").val();
		var h = time.split("-")[1];
		var day = time.split(" ")[0];
		var hour = h.split(":")[0];
		if (hour.substr(0, 1) == "0") {
			hour = hour.substring(hour.length, 1);
		}
		if (hh >= hour && day == "今天") {
			var msg = "请重新选择上门时间";
			handleDomMsg(msg);
			return;
		}

		var layerhome;
		var layerIndex;
		console.log($("#time").val())
		layui.use('layer', function() {
			layerhome = layui.layer;
			layerhome.ready(function() {
				layerIndex = layerhome.load(1, {
					shade : [ 0.3, '#000' ]
				});
			})
		});
		$.ajax({
			url : "../express/appointmentExpress1.hn",
			type : 'post',
			data : {
				send_name : $("#name").val(),
				send_phone : $("#phone").val(),
				area : $("#area").val(),
				address : $("#address").val(),
				time : $("#time").val(),
				sample_id : sample_id
			},
			dataType : "json",
			success : function(data) {
				if (data.success) {
					window.location = "./appointment_success.html?sample_id=" + sample_id + "&openid=" + valOpenid;
				} else {
					handleDomMsg(data.msg);
					return;
				}
			},
			complete : function() {
				setTimeout(function() {
					layerhome.close(layerIndex);
				}, 1000)
			}
		});
	}

	//时间选择器
	function getTime() {
		var time_select = [];
		var time_tom = {};
		var time_after = {};
		var time_today = [];
		var today = new Date(); //返回当前日期和时间
		var hour_now = today.getHours(); //返回 Date 对象的小时 (0 ~ 23)获取当前小时
		var id = 1;
		var time_ = {};
		time_.id = "1";
		time_.value = "今天";
		for (var i = hour_now; i <= 17; i++) {
			var time_t = {};
			if (hour_now < 10) {
				if (hour_now + 1 < 10) {
					var time_appointment = "0" + i + ":00-" + "0" + (i + 1) + ":00";
				} else {
					var time_appointment = "0" + i + ":00-" + (i + 1) + ":00";
				}
				time_t.id = id;
				time_t.value = time_appointment;

			} else {
				var time_appointment = i + ":00-" + (i + 1) + ":00";
				time_t.id = id;
				time_t.value = time_appointment;
			}
			id++;
			time_today.push(time_t);
		}
		time_.childs = time_today;
		time_tom = {
			"id" : "2",
			"value" : "明天",
			"childs" : [
				{
					"id" : "1",
					"value" : "08:00-09:00"
				},
				{
					"id" : "2",
					"value" : "09:00-10:00"
				},
				{
					"id" : "3",
					"value" : "10:00-11:00"
				},
				{
					"id" : "4",
					"value" : "11:00-12:00"
				},
				{
					"id" : "5",
					"value" : "13:00-14:00"
				},
				{
					"id" : "6",
					"value" : "15:00-16:00"
				},
				{
					"id" : "7",
					"value" : "16:00-17:00"
				},
				{
					"id" : "8",
					"value" : "17:00-18:00"
				}
			]
		};
		time_after = {
			"id" : "3",
			"value" : "后天",
			"childs" : [
				{
					"id" : "1",
					"value" : "08:00-09:00"
				},
				{
					"id" : "2",
					"value" : "09:00-10:00"
				},
				{
					"id" : "3",
					"value" : "10:00-11:00"
				},
				{
					"id" : "4",
					"value" : "11:00-12:00"
				},
				{
					"id" : "5",
					"value" : "13:00-14:00"
				},
				{
					"id" : "6",
					"value" : "15:00-16:00"
				},
				{
					"id" : "7",
					"value" : "16:00-17:00"
				},
				{
					"id" : "8",
					"value" : "17:00-18:00"
				}
			]
		};
		time_select.push(time_);
		time_select.push(time_tom);
		time_select.push(time_after);
		UplinkData.concat(time_select);
		console.log(time_select);
		var mobileSelect_time = new MobileSelect({
			trigger : "#time",
			title : "预约时间选择",
			wheels : [ {
				data : time_select
			} ],
			position : [ 0, 0 ],
			transitionEnd : function(indexArr, data) {
				//console.log(data);
			},
			callback : function(indexArr, data) {
				console.log(data);
				var time = data[0].value + " " + data[1].value;
				$('#time').val(time);
			},
		});

	}
	
	//alert 弹窗不显示域名
		var wAlert = window.alert;
		window.alert = function (message) {
			try {
				var iframe = document.createElement("IFRAME");
				iframe.style.display = "none";
				iframe.setAttribute("src", 'data:text/plain,');
				document.documentElement.appendChild(iframe);
				var alertFrame = window.frames[0];
				var iwindow = alertFrame.window;
				if (iwindow == undefined) {
					iwindow = alertFrame.contentWindow;
				}
				iwindow.alert(message);
				iframe.parentNode.removeChild(iframe);
			}
			catch (exc) {
				return wAlert(message);
			}
		}
		var wConfirm = window.confirm;
		window.confirm = function (message) {
			try {
				var iframe = document.createElement("IFRAME");
				iframe.style.display = "none";
				iframe.setAttribute("src", 'data:text/plain,');
				document.documentElement.appendChild(iframe);
				var alertFrame = window.frames[0];
				var iwindow = alertFrame.window;
				if (iwindow == undefined) {
					iwindow = alertFrame.contentWindow;
				}
				iwindow.confirm(message);
				iframe.parentNode.removeChild(iframe);
			}
			catch (exc) {
				return wConfirm(message);
			}
		}
		
		function Confirm(str, click) {
			var confirmFram = document.createElement("DIV");
			confirmFram.id = "confirmFram";
			confirmFram.style.position = "fixed";
			confirmFram.style.width = "100%";
			confirmFram.style.height = "120%";
			confirmFram.style.top = "0";
			confirmFram.style.textAlign = "center";
			confirmFram.style.lineHeight = "150px";
			confirmFram.style.zIndex = "300";
			confirmFram.style.backgroundColor = "rgba(0, 0, 0, 0.58)";
			confirmFram.style.fontSize = "12px";
			strHtml = '<ul class="confirm_ul">';
			strHtml += '<li class="confirm_content">' + str + '</li>';
			strHtml += '<li class="confirm_btn-wrap"><a type="button" value="分开邮寄" onclick="doFalse()" class="confirm_btn">分开邮寄</a><a type="button" value="一起邮寄" onclick="doOk()" class="confirm_btn">一起邮寄</a></li>';
			strHtml += '</ul>';
			confirmFram.innerHTML = strHtml;
			document.body.appendChild(confirmFram);
			this.doOk = function () {
				confirmFram.style.display = "none";
				if (typeof click == "function") {
					click();
					return true;
				}
			}
			this.doFalse = function () {
				confirmFram.style.display = "none";
				if (typeof click == "function") {
					return false;
				}
			}
		}
</script>
</html>